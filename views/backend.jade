//
   Created with JetBrains WebStorm.
   User: Johnny
   Date: 28/04/13
   Time: 16:31
   To change this template use File | Settings | File Templates.

extends layout

block scripts
  script
    $(document).ready(function() {

      checkField($('#error_new'));
      checkField($('#msg_new'));

      $('#info-cktl').on('hide', function () {
        $('#info-cktl-title').empty();
        $('#info-cktl-img').empty();
        $('#info-cktl-info').empty();
      });

      cargarCocktails();

      $('#btn-new').click(function() {
        $('#new-cktl').modal();
      });
    });

    function cargarCocktails() {
      var progressbar = $('#progress-bar')[0];
      $(progressbar.parentElement).removeClass('hide');
      var ulcocktails = $('#ul-cocktails');
      $(ulcocktails).empty();
      $('#div-dropdown').addClass('hide');
      $.ajax({
       url: '/cocktails_admin',
       method: 'get',
       dataType: 'json',
       beforeSend: function(header) {
         progressbar.style.width = '40%';
       },
       success: function(data, textStatus, jqXHR) {
         progressbar.style.width = '80%';
         $.each(data, function(i, cktl){
           var style = '';
           if (cktl.recomendado) {
               var style = 'font-weight: bold;';
               $("#recommended-cocktail h2").text("Cocktail recomendado: " + cktl.nombre);
           }
           var link = $('<a>', {
             href: '#info-cktl',
             style: style,
             click: function() {
               loadCocktail(cktl);
             },
             text: cktl.nombre
           });
           link.attr('data-toggle', 'modal');
           var li = $('<li>', {});
           li.append(link);
           ulcocktails.append(li);
         });
         progressbar.style.width = '100%';
         setTimeout(eliminarBarra, 500);
       },
       error: function(jqXHR, textStatus, errorThrown) {
         $(progressbar.parentElement).addClass('progress-danger');
         $('#errors-cocktail-list').text('Error recuperando la lista de cocktails: ' + jqXHR.status + ' ' + errorThrown).removeClass('hide');
       }
      });
    }

    function eliminarBarra() {
      var progressbar = $('#progress-bar')[0];
      $(progressbar.parentElement).addClass('hide');
      $('#div-dropdown').removeClass('hide');
      $('#btn-new').removeClass('hide');
    }

    function loadCocktail(cktl) {
      $('#info-cktl-title').text('Cocktail ' + cktl.nombre);
      loadImageCocktail(cktl.nombre, cktl.vaso, cktl.color);
      $('#info-cktl-info').append('<p><strong>Nombre:</strong> ' + cktl.nombre + '<br>'
        + '<strong>Zumos:</strong> ' + cktl.zumos.join(', ') + '<br>'
        + '<strong>Licores:</strong> ' + cktl.licores.join(', ') + '<br>'
        + '<strong>Carb&oacute;nico:</strong> ' + cktl.carbonico + '</p>');
      $('#info-cktl-guardar').unbind('click').click(function() {
        recomendarCocktail(cktl._id);
      });
    }

    function loadImageCocktail(nombre, vaso, color) {
      var img = $('#info-cktl-img');
      img.append('Loading...'); //TODO Posar un gif o una animacio
      $.ajax({
        url: '/image/' + vaso + '/' + color,
        method: 'get',
        dataType: 'json',
        success: function(data) {
          img.empty();
          img.append($('<img>', {
            src: data.img,
            alt: 'Cocktail ' + nombre
          }));
        },
        error: function(jqXHR, textStatus, errorThrown) {

        }
      });
    }

    function recomendarCocktail(id) {
      $.ajax({
        url: '/admin/recommend/' + id,
        method: 'get',
        success: function(data) {
          $('#info-cktl').modal('hide');
          cargarCocktails();
        },
        error: function(jqXHR, textStatus, errorThrown) {
          alert("ERROR!");
          console.log(jqXHR);
          console.log(textStatus);
          console.log(errorThrown);
        }
      });
    }


block content
  #header.well
    h1 #{title}

  #content.container-fluid
    .row-fluid
      #img-uploader.well
        h2 Subida de im&aacute;genes
        form(action="/images", method="post", enctype="multipart/form-data")
          input(type="file", name="imageFile")
          input(type="submit", name="submitButton")
            i.btn.btn-success Subir

    .row-fluid
      #map-locations.well
        h2 Puntos en el mapa
        p Pendiente...

    .row-fluid
      #recommended-cocktail.well
        h2 Cocktails
        #recommended-cocktail-container
          .progress.progress-striped.active
            #progress-bar.bar(style='width: 0%;')
        #div-dropdown.btn-group.hide
          a.btn.dropdown-toggle(data-toggle='dropdown', href='#') Elige un cocktail
          ul#ul-cocktails.dropdown-menu
        &nbsp;
        &nbsp;
        button#btn-new.btn.btn-primary.hide Nuevo cocktail
        #errors-cocktail-list.alert.alert-error.hide
        #alerts
          #error_new.alert.alert-error #{error_new}
          #msg_new.alert.alert-info #{msg_new}

  #info-cktl.modal.hide.fade
    .modal-header
      button.close(type='button', data-dismiss='modal', aria-hidden='true') &times;
      h3#info-cktl-title
    .modal-body
      .container-fluid
        .row-fluid
          .span3#info-cktl-img
          .span9#info-cktl-info
    .modal-footer
      a#info-cktl-guardar.btn.btn-primary Recomendar

  #new-cktl.modal.hide.fade
    .modal-header
      button.close(type='button', data-dismiss='modal', aria-hidden='true') &times;
      h3#info-cktl-title Nuevo cocktail
    .modal-body
      form#form-new.form-horizontal(action='/cocktails_admin', method='post')
        .control-group
          label.control-label(for='inputNombre') Nombre
          .controls
            input#inputNombre(type='text', placeholder='Nombre', name='nombre', required)
        .control-group
          label.control-label(for='inputZumos') Zumos
          .controls
            select#inputZumos(multiple='multiple', name='zumos', required)
              option Zumo de naranja
              option Zumo de manzana
              option Zumo de pi&ntilde;a
              option Zumo de fresa
        .control-group
          label.control-label(for='inputLicores') Licores
          .controls
            select#inputLicores(multiple='multiple', name='licores', required)
              option Ron
              option Whisky
              option Vodka
              option Ginebra
              option Tequila
              option Absenta
        .control-group
          label.control-label(for='inputCarbonico') Carb&oacute;nico
          .controls
            select#inputCarbonico(name='carbonico', required)
              option Cola
              option Lim&oacute;n
              option Naranja
              option T&oacute;nica
        .control-group
          label.control-label(for='inputVaso') Vaso
          .controls
            select#inputVaso(name='vaso', required)
              option Cubata
              option Chupito
              option Pinta
        .control-group
          label.control-label(for='inputColor') Color
          .controls
            select#inputColor(name='color', required)
              option Blanco
              option Amarillo
              option Verde
              option Naranja
              option Rojo
              option Azul
              option Negro
    .modal-footer
      btn#new-cktl-guardar.btn.btn-primary(onclick='$("#form-new").submit();') Guardar